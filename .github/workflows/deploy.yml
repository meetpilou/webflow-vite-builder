name: Deploy to BunnyCDN

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      BUNNY_STORAGE_NAME: ${{ secrets.BUNNY_STORAGE_NAME }}
      BUNNY_STORAGE_KEY: ${{ secrets.BUNNY_STORAGE_KEY }}
      BUNNY_PULLZONE_ID: ${{ secrets.BUNNY_PULLZONE_ID }}
      BUNNY_API_KEY: ${{ secrets.BUNNY_API_KEY }}

    steps:
      # --------------------------------------------------
      # üß∞ Checkout + Node
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --------------------------------------------------
      # üß© Check BunnyCDN secrets
      # --------------------------------------------------
      - name: Verify BunnyCDN secrets
        id: check_bunny
        shell: bash
        run: |
          MISSING=0

          if [ -z "${BUNNY_STORAGE_NAME}" ]; then
            echo "‚ùå Missing secret: BUNNY_STORAGE_NAME"
            MISSING=1
          fi

          if [ -z "${BUNNY_STORAGE_KEY}" ]; then
            echo "‚ùå Missing secret: BUNNY_STORAGE_KEY"
            MISSING=1
          fi

          if [ -z "${BUNNY_PULLZONE_ID}" ]; then
            echo "‚ùå Missing secret: BUNNY_PULLZONE_ID"
            MISSING=1
          fi

          if [ -z "${BUNNY_API_KEY}" ]; then
            echo "‚ùå Missing secret: BUNNY_API_KEY"
            MISSING=1
          fi

          if [ $MISSING -eq 1 ]; then
            echo "‚ö†Ô∏è Missing required BunnyCDN secrets ‚Äî skipping deployment."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ All BunnyCDN secrets are present."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      # --------------------------------------------------
      # üì¶ Install dependencies (needed for restore/snippet scripts)
      # --------------------------------------------------
      - name: Install dependencies
        if: steps.check_bunny.outputs.skip == 'false'
        run: |
          if [ -f "yarn.lock" ]; then
            yarn install
          else
            npm install
          fi

      # --------------------------------------------------
      # ‚ö†Ô∏è Skip Build (local build required)
      # --------------------------------------------------
      - name: Skip build (local only)
        run: echo "‚è≠Ô∏è Build skipped ‚Äî deploying existing dist/ only."

      # --------------------------------------------------
      # üìÇ Deploy entire dist/ folder recursively
      # --------------------------------------------------
      - name: Upload all dist files
        if: steps.check_bunny.outputs.skip == 'false'
        shell: bash
        run: |
          STORAGE="https://storage.bunnycdn.com/${BUNNY_STORAGE_NAME}"
          ACCESS="${BUNNY_STORAGE_KEY}"

          echo "üìÇ Uploading full dist/ directory to Bunny Storage..."

          if [ ! -d "dist" ]; then
            echo "‚ùå dist/ folder not found. Did you build locally?"
            exit 1
          fi

          # Walk all files
          find dist -type f | while read FILE; do
            # Remove leading 'dist/' to get relative path
            REL_PATH="${FILE#dist/}"

            echo "‚¨ÜÔ∏è Uploading: $REL_PATH"

            # Create target folders if necessary
            DIR_PATH=$(dirname "$REL_PATH")
            if [ "$DIR_PATH" != "." ]; then
              curl -s -X PUT "$STORAGE/$DIR_PATH/" \
                -H "AccessKey: $ACCESS" \
                -H "Content-Length: 0" >/dev/null
            fi

            # Upload file
            if curl -sf -X PUT "$STORAGE/$REL_PATH" \
              -H "AccessKey: $ACCESS" \
              --data-binary @"$FILE" >/dev/null; then
              echo "   ‚úÖ Uploaded"
            else
              echo "   ‚ùå FAILED"
            fi
          done

          echo "üìÅ Upload complete."

      # --------------------------------------------------
      # üßπ Purge Bunny CDN Cache
      # --------------------------------------------------
      - name: Purge Bunny.net Cache
        if: steps.check_bunny.outputs.skip == 'false'
        shell: bash
        run: |
          echo "üßπ Purging cache for Pull Zone: ${BUNNY_PULLZONE_ID}"

          RESPONSE=$(curl -s -X POST "https://api.bunny.net/pullzone/${BUNNY_PULLZONE_ID}/purgeCache" \
            -H "AccessKey: ${BUNNY_API_KEY}" \
            -H "accept: application/json" \
            -w "HTTPSTATUS:%{http_code}")

          BODY=$(echo "$RESPONSE" | sed -e 's/HTTPSTATUS:.*//')
          STATUS=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')

          echo "üîé API Response: $BODY"
          echo "üîé HTTP status: $STATUS"

          if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 300 ]; then
            echo "‚úÖ Cache successfully purged."
          else
            echo "‚ùå Cache purge failed."
            exit 1
          fi

      # --------------------------------------------------
      # üéâ Done
      # --------------------------------------------------
      - name: Done
        if: steps.check_bunny.outputs.skip == 'false'
        run: echo "üöÄ Deployment completed successfully!"
